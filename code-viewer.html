<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Code Viewer</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <style>
      body { background: rgba(0,0,0,0.45); height:100vh; display:flex; align-items:center; justify-content:center; margin:0 }
      .viewer { width:90%; max-width:1100px; max-height:90vh; background:#fff; border-radius:10px; box-shadow:0 12px 36px rgba(0,0,0,0.25); overflow:hidden; display:flex; flex-direction:column }
      .viewer .toolbar { display:flex; align-items:center; gap:12px; padding:12px 16px; background:#0b5; background:linear-gradient(90deg,#1f6feb,#0b79c1); color:#fff }
      .viewer .title { font-weight:700; font-family: 'Montserrat', sans-serif }
      .viewer .actions { margin-left:auto }
      .viewer .code-wrap { padding:16px; overflow:auto; background:#0b1220 }
      pre { margin:0 }
      .muted { opacity:0.9 }
      a.btn-download { color:inherit }
    </style>
  </head>
  <body>
    <div class="viewer" role="dialog" aria-modal="true">
      <div class="toolbar">
        <div class="title">Code Viewer</div>
        <div class="ms-3 muted" id="filePath">Loading...</div>
        <div class="actions">
          <a id="downloadLink" class="btn btn-sm btn-light btn-download" href="#" download>Download</a>
          <button id="closeBtn" class="btn btn-sm btn-outline-light ms-2">Close</button>
        </div>
      </div>
      <div class="code-wrap">
        <pre><code id="codeblock" class="language-cpp">Loading...</code></pre>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>hljs.configure({languages:['cpp','c','java','python','javascript']});</script>
    <script>
      // Helper to escape HTML
      function escapeHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      const fileParam = getQueryParam('file');
      const displayPath = document.getElementById('filePath');
      const downloadLink = document.getElementById('downloadLink');
      const codeblock = document.getElementById('codeblock');

      function closeViewer(){
        if (document.referrer && document.referrer !== window.location.href) {
          window.history.back();
        } else {
          // fallback to index
          window.location.href = 'nightguard-code.html';
        }
      }

      document.getElementById('closeBtn').addEventListener('click', closeViewer);

      if (!fileParam) {
        displayPath.textContent = 'No file specified';
        codeblock.textContent = 'No file parameter was provided in the URL (e.g. ?file=dijkstra.cpp)';
      } else {
        // sanitize filename (allow only simple filenames)
        const safe = fileParam.replace(/[^a-zA-Z0-9_\-.]/g,'');
        const fileUrl = 'code/' + safe;
        displayPath.textContent = safe;
        downloadLink.href = fileUrl;

        fetch(fileUrl).then(res => {
          if (!res.ok) throw new Error('Could not load file: ' + res.status);
          return res.text();
        }).then(txt => {
          codeblock.innerHTML = escapeHtml(txt);
          hljs.highlightElement(codeblock);
        }).catch(err => {
          codeblock.textContent = err.toString();
        });
      }

      // close on Esc
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeViewer(); });
    </script>
  </body>
</html>
